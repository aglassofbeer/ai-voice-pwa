<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AIãƒœã‚¤ã‚¹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.8; }
    section { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
    h2 { font-size: 1.2em; margin-bottom: 10px; }
    button { margin: 5px; padding: 8px 16px; }
    .settings label { display: block; margin-bottom: 0; }
    #chatLog { display: flex; flex-direction: column; gap: 6px; max-height: 21em; overflow-y: auto; padding: 5px; border-top: 1px solid #ddd; margin-top: 10px; font-size: 0.95em; }
    .user, .assistant { max-width: 80%; padding: 6px 10px; border-radius: 12px; word-wrap: break-word; }
    .user { align-self: flex-start; background-color: #f0f0f0; color: #333; }
    .assistant { align-self: flex-end; background-color: #d8ebff; color: #003366; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .spin-icon { display: inline-block; animation: spin 1s linear infinite; }
    #responseTimer { margin-left: 10px; font-size: 0.9em; color: #555; }
    #textSection { display: none; }
  </style>
</head>
<body>
  <h1>ğŸ¤ Chat</h1>
  <section>
    <div class="settings">
      <label>aä¼šè©±ã‚¹ã‚¿ã‚¤ãƒ«:
        <select id="chatStyleSelect">
          <option value="voice">éŸ³å£°</option>
          <option value="text">ãƒ†ã‚­ã‚¹ãƒˆ</option>
        </select>
      </label>
    </div>
  </section>

  <section id="voiceSection">
    <h2>ğŸ—£ éŒ²éŸ³ â†’ Whisper â†’ GPT â†’ TTS</h2>
    <button id="voiceRecBtn">ğŸ™ éŒ²éŸ³</button>
    <button id="voiceStopBtn" disabled>â¹ åœæ­¢ãƒ»é€ä¿¡</button>
    <button id="cancelRecBtn">ğŸ›‘ ã‚„ã‚Šç›´ã—</button>
    <span id="responseTimer"></span>
    <audio id="voiceAudio" controls></audio>
  </section>

  <section id="textSection">
    <h2>âœï¸ ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› â†’ GPT â†’ TTS</h2>
    <textarea id="textInput" rows="3" style="width: 100%;"></textarea><br>
    <button id="sendTextBtn">é€ä¿¡</button>
    <audio id="textAudio" controls></audio>
  </section>

  <section>
    <div class="settings">
      <label>è¨€èª:
        <select id="langSelect">
          <option value="ja">æ—¥æœ¬èª</option>
          <option value="en">English</option>
          <option value="zh" selected>ä¸­æ–‡</option>
        </select>
      </label>
      <label>STTãƒ¢ãƒ‡ãƒ«:
        <select id="sttModelSelect">
          <option value="whisper-1">Whisperï¼ˆé«˜é€Ÿãƒ»å®‰ä¾¡ï¼‰</option>
          <option value="gpt-4o-transcribe">GPT-4o Transcribe</option>
          <option value="gpt-4o-mini-transcribe" selected>GPT-4o mini Transcribe</option>
        </select>
      </label>
      <label>GPTãƒ¢ãƒ‡ãƒ«:
        <select id="gptModelSelect">
          <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
          <option value="gpt-4o">gpt-4o</option>
          <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
        </select>
      </label>
      <label>TTSãƒ¢ãƒ‡ãƒ«:
        <select id="ttsModelSelect">
          <option value="gpt-4o-mini-tts" selected>gpt-4o-mini-tts</option>
          <option value="tts-1">tts-1</option>
          <option value="tts-1-hd">tts-1-hd</option>
        </select>
      </label>
      <label>éŸ³å£°:
        <select id="voiceSelect">
          <option value="alloy">alloy</option>
          <option value="echo">echo</option>
          <option value="fable">fable</option>
          <option value="onyx">onyx</option>
          <option value="nova">nova</option>
          <option value="shimmer">shimmer</option>
        </select>
      </label>
    </div>
    <div id="chatLog"></div>
  </section>

  <script>
    const serverUrl = "https://ai-voice-server-31vd.onrender.com";
    const chatLogElem = document.getElementById("chatLog");
    const responseTimerElem = document.getElementById("responseTimer");
    let responseStartTime = null;
    let timerInterval = null;

    const appendToChatLog = (role, text) => {
      const div = document.createElement("div");
      div.className = role === "user" ? "user" : "assistant";
      div.textContent = (role === "user" ? "ğŸ§‘ " : "ğŸ¤– ") + text;
      chatLogElem.appendChild(div);
      chatLogElem.scrollTop = chatLogElem.scrollHeight;
    };

    document.getElementById("chatStyleSelect").onchange = e => {
      const style = e.target.value;
      document.getElementById("voiceSection").style.display = style === "voice" ? "block" : "none";
      document.getElementById("textSection").style.display = style === "text" ? "block" : "none";
    };

    // Texté€ä¿¡å‡¦ç†
    document.getElementById("sendTextBtn").onclick = async () => {
      const sendBtn = document.getElementById("sendTextBtn");
      const text = document.getElementById("textInput").value.trim();
      if (!text) return;
      appendToChatLog("user", text);
      const payload = {
        text,
        lang: document.getElementById("langSelect").value,
        gptModel: document.getElementById("gptModelSelect").value,
        ttsModel: document.getElementById("ttsModelSelect").value,
        ttsVoice: document.getElementById("voiceSelect").value
      };
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span class="spin-icon">â³</span> é€ä¿¡ä¸­...';
      responseStartTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = ((Date.now() - responseStartTime) / 1000).toFixed(1);
        responseTimerElem.textContent = `â± ${elapsed} ç§’`;
      }, 100);
      const res = await fetch(`${serverUrl}/text`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      clearInterval(timerInterval);
      const finalElapsed = ((Date.now() - responseStartTime) / 1000).toFixed(1);
      responseTimerElem.textContent = `â± ${finalElapsed} ç§’`;
      const audioBlob = new Blob([Uint8Array.from(atob(data.audio), c => c.charCodeAt(0))], { type: "audio/mpeg" });
      const audioUrl = URL.createObjectURL(audioBlob);
      document.getElementById("textAudio").src = audioUrl;
      document.getElementById("textAudio").play();
      appendToChatLog("assistant", data.reply);
      document.getElementById("textInput").value = "";
      sendBtn.disabled = false;
      sendBtn.innerHTML = "é€ä¿¡";
    };

    // VoiceéŒ²éŸ³å‡¦ç†ï¼ˆé€ä¿¡ï¼‰
    let recorder;
    let chunks = [];

    document.getElementById("voiceRecBtn").onclick = async () => {
      chunks = [];
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = async () => {
        const blob = new Blob(chunks, { type: "audio/webm" });
        const formData = new FormData();
        formData.append("audio", blob, "voice.webm");
        formData.append("lang", document.getElementById("langSelect").value);
        formData.append("stt_model", document.getElementById("sttModelSelect").value);
        formData.append("gptModel", document.getElementById("gptModelSelect").value);
        formData.append("ttsModel", document.getElementById("ttsModelSelect").value);
        formData.append("voice", document.getElementById("voiceSelect").value);
        formData.append("chatMode", "chat");
        const stopBtn = document.getElementById("voiceStopBtn");
        stopBtn.disabled = true;
        stopBtn.innerHTML = '<span class="spin-icon">â³</span> é€ä¿¡ä¸­...';
        responseStartTime = Date.now();
        timerInterval = setInterval(() => {
          const elapsed = ((Date.now() - responseStartTime) / 1000).toFixed(1);
          responseTimerElem.textContent = `â± ${elapsed} ç§’`;
        }, 100);
        const res = await fetch(`${serverUrl}/voice`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        clearInterval(timerInterval);
        const finalElapsed = ((Date.now() - responseStartTime) / 1000).toFixed(1);
        responseTimerElem.textContent = `â± ${finalElapsed} ç§’`;
        const audioBlob = new Blob([Uint8Array.from(atob(data.audio), c => c.charCodeAt(0))], { type: "audio/mpeg" });
        const audioUrl = URL.createObjectURL(audioBlob);
        document.getElementById("voiceAudio").src = audioUrl;
        document.getElementById("voiceAudio").play();
        appendToChatLog("user", data.whisper);
        appendToChatLog("assistant", data.reply);
        stopBtn.innerHTML = "â¹ åœæ­¢ãƒ»é€ä¿¡";
      };
      recorder.start();
      document.getElementById("voiceRecBtn").disabled = true;
      document.getElementById("voiceStopBtn").disabled = false;
    };

    document.getElementById("voiceStopBtn").onclick = () => {
      recorder.stop();
      document.getElementById("voiceRecBtn").disabled = false;
    };
  </script>
</body>
</html>
